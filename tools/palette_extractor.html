<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Palette Extractor</title>
    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
      .row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
      .swatch { width: 96px; height: 72px; border-radius: 8px; border: 1px solid #00000020; position: relative; }
      .swatch span { position: absolute; left: 8px; bottom: 8px; font-size: 12px; color: #000; text-shadow: 0 1px 2px #ffffffa0; background: #ffffffd0; padding: 2px 4px; border-radius: 4px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(96px, 1fr)); gap: 12px; margin-top: 12px; }
      .meta { font-size: 12px; color: #444; }
      canvas { display: none; }
      .hint { color: #555; font-size: 14px; }
      .code { white-space: pre; background: #f7f7f8; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; }
    </style>
  </head>
  <body>
    <h1>Palette Extractor</h1>
    <p class="hint">Open this file in your browser. Either use the default sample image or choose another image. The tool extracts top colors using k-means from a downscaled canvas.</p>
    <div class="row">
      <input type="file" id="file" accept="image/*" />
      <label>
        Colors:
        <select id="k">
          <option>6</option>
          <option selected>8</option>
          <option>10</option>
          <option>12</option>
        </select>
      </label>
      <label>
        Downscale:
        <select id="size">
          <option>128</option>
          <option selected>200</option>
          <option>256</option>
          <option>320</option>
        </select>
      </label>
      <button id="run">Extract</button>
    </div>
    <div class="row" style="margin-top:12px">
      <img id="img" alt="sample" style="max-width: 360px; border-radius: 8px; border:1px solid #e5e7eb" src="../sample-theme.jpg" />
      <div>
        <div id="info" class="meta"></div>
        <div id="palette" class="grid"></div>
      </div>
    </div>
    <h3>JSON Output</h3>
    <div id="json" class="code"></div>
    <canvas id="cv"></canvas>
    <script>
      const img = document.getElementById('img');
      const file = document.getElementById('file');
      const kSel = document.getElementById('k');
      const sizeSel = document.getElementById('size');
      const runBtn = document.getElementById('run');
      const cv = document.getElementById('cv');
      const info = document.getElementById('info');
      const paletteEl = document.getElementById('palette');
      const jsonEl = document.getElementById('json');

      file.addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (f) {
          const url = URL.createObjectURL(f);
          img.src = url;
        }
      });

      function hex([r,g,b]){ return '#' + [r,g,b].map(v=>v.toString(16).padStart(2,'0')).join(''); }
      function dist2(a,b){ let d0=a[0]-b[0], d1=a[1]-b[1], d2=a[2]-b[2]; return d0*d0+d1*d1+d2*d2; }

      function kmeans(points, k=8, iters=12){
        // init: pick k random points
        const centroids = [];
        const used = new Set();
        while(centroids.length < k){
          const idx = Math.floor(Math.random()*points.length);
          if(!used.has(idx)) { used.add(idx); centroids.push(points[idx].slice()); }
        }
        let labels = new Array(points.length).fill(0);
        for(let t=0;t<iters;t++){
          // assign
          for(let i=0;i<points.length;i++){
            let best=0, bd=Infinity; const p=points[i];
            for(let c=0;c<k;c++){
              const d = dist2(p, centroids[c]);
              if(d<bd){ bd=d; best=c; }
            }
            labels[i]=best;
          }
          // update
          const sums = Array.from({length:k},()=>[0,0,0,0]);
          for(let i=0;i<points.length;i++){
            const c = labels[i]; const p=points[i];
            sums[c][0]+=p[0]; sums[c][1]+=p[1]; sums[c][2]+=p[2]; sums[c][3]++;
          }
          for(let c=0;c<k;c++){
            const n = Math.max(1, sums[c][3]);
            centroids[c][0]=Math.round(sums[c][0]/n);
            centroids[c][1]=Math.round(sums[c][1]/n);
            centroids[c][2]=Math.round(sums[c][2]/n);
          }
        }
        return {centroids, labels};
      }

      function extract(){
        const K = parseInt(kSel.value,10);
        const SZ = parseInt(sizeSel.value,10);
        const ctx = cv.getContext('2d', { willReadFrequently: true });
        const r = img.naturalWidth/img.naturalHeight;
        const w = SZ, h = Math.max(1, Math.round(SZ/r));
        cv.width = w; cv.height = h;
        ctx.drawImage(img, 0,0,w,h);
        const {data} = ctx.getImageData(0,0,w,h);
        const pts = [];
        for(let i=0;i<data.length;i+=4){
          const a = data[i+3]; if(a<8) continue; // skip near-transparent
          pts.push([data[i], data[i+1], data[i+2]]);
        }
        // sample to limit max points
        const MAX = 6000;
        if(pts.length > MAX){
          const step = Math.floor(pts.length / MAX);
          const sampled=[]; for(let i=0;i<pts.length;i+=step) sampled.push(pts[i]);
          pts.length=0; Array.prototype.push.apply(pts, sampled);
        }
        const {centroids, labels} = kmeans(pts, K, 10);
        // frequencies
        const freq = Array(K).fill(0);
        labels.forEach(l=>freq[l]++);
        const total = labels.length;
        const palette = centroids.map((c,i)=>({hex: hex(c), rgb: c, pct: +(freq[i]/total).toFixed(4)}));
        palette.sort((a,b)=>b.pct-a.pct);

        // render
        info.textContent = `Image ${img.naturalWidth}×${img.naturalHeight}, downscaled to ${w}×${h}. Colors=${K}.`;
        paletteEl.innerHTML = '';
        palette.forEach(p=>{
          const d=document.createElement('div'); d.className='swatch'; d.style.background=p.hex; d.title=`${p.hex} • ${(p.pct*100).toFixed(1)}%`;
          const s=document.createElement('span'); s.textContent = `${p.hex} ${(p.pct*100).toFixed(1)}%`;
          d.appendChild(s); paletteEl.appendChild(d);
        });
        jsonEl.textContent = JSON.stringify(palette, null, 2);
      }

      runBtn.addEventListener('click', extract);
      img.addEventListener('load', ()=> info.textContent = 'Ready. Click Extract to compute palette.');
      if(img.complete) info.textContent = 'Ready. Click Extract to compute palette.';
    </script>
  </body>
  </html>

